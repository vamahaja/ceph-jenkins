#!/bin/bash

# Create RPM and release build area
mkdir -p "${RPM_BUILDAREA}"/{SOURCES,SRPMS,SPECS,RPMS,BUILD}
mkdir -p "${RELEASE_BUILDAREA}"/{SOURCES,SPECS,RPMS,BUILD}

# Copy required configs from dist to RPM_BUILDAREA
cp -v dist/ceph.spec "${RPM_BUILDAREA}/SPECS/ceph.spec"
cp -v "dist/ceph-${VERSION}.tar.bz2" "${RPM_BUILDAREA}/SOURCES/"

sudo dnf builddep -y \
        --setopt="*.skip_if_unavailable=true" \
        "${RPM_BUILDAREA}/SPECS/ceph.spec"

# Get number of CPUs to use for build
CPUS=${ALLOCATED_CPUS:-1}

# Start the compilation and packaging
cd "${RPM_BUILDAREA}/SPECS"
rpmbuild -ba \
    --define "_topdir ${RPM_BUILDAREA}" \
    --define "_smp_mflags -j${CPUS}" \
    --define "debug_package %{nil}" \
    --define "_lto_cflags %{nil}" \
    ${RPM_BUILD_OPTS:+${RPM_BUILD_OPTS}} \
    "${RPM_BUILDAREA}/SPECS/ceph.spec"

# Generate the .repo file
cat <<EOF > "${RELEASE_BUILDAREA}/SOURCES/ceph.repo"
[Ceph]
name=Ceph packages for \$basearch
baseurl=${REPO_URL}/\$basearch
enabled=1
gpgcheck=0
type=rpm-md

[Ceph-noarch]
name=Ceph noarch packages
baseurl=${REPO_URL}/noarch
enabled=1
gpgcheck=0
type=rpm-md
EOF

# Generate the spec for the release package
cat <<EOF > "${RELEASE_BUILDAREA}/SPECS/ceph-release.spec"
Name:           ceph-release
Version:        1
Release:        0%{?dist}
Summary:        Ceph Development repository configuration
License:        GPLv2
URL:            ${REPO_URL}
Source0:        ceph.repo
BuildArch:      noarch

%description
This package contains the yum configuration for a specific Ceph development build.

%prep
%setup -q -c -T
install -pm 644 %{SOURCE0} .

%install
install -dm 755 %{buildroot}/etc/yum.repos.d
install -pm 644 %{SOURCE0} %{buildroot}/etc/yum.repos.d

%files
/etc/yum.repos.d/ceph.repo
EOF

# Build the release RPM
cd "${RELEASE_BUILDAREA}/SPECS"
rpmbuild -bb \
    --define "_topdir ${RELEASE_BUILDAREA}" \
    "${RELEASE_BUILDAREA}/SPECS/ceph-release.spec"

# Extract standalone cephadm
cd "${WORKSPACE}"
RPM_PATH=$(find "${RELEASE_BUILDAREA}/RPMS" -name "cephadm-*.rpm" | head -n 1)
if [ -f "${RPM_PATH}" ]; then
    rpm2cpio "${RPM_PATH}" | cpio -i --to-stdout *sbin/cephadm > cephadm
    echo "Extracted cephadm binary to ${WORKSPACE}/cephadm"
fi

echo "RPM Build and cephadm extraction completed."